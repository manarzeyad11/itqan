<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice</title>
    <link rel="stylesheet" href="../assets/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/invoice.css">
</head>

<body>

    <div class="container">
        <label for="">Account Name: </label>

        <div class="containeri">

            <div class="search-container">
                <input type="text" id="searchInput" placeholder="Search...">
                <ul id="searchResults" class="search-results-container"></ul>
            </div>

        </div>

        <!-- Currency Options Box -->
        <div class="currency-container">
            <label for="currencySelect">Select Currency: </label>
            <select id="currencySelect">
                <option value="NIS">NIS</option>
                <option value="JOD">JOD</option>
                <option value="USD">USD</option>
                <option value="EUR">EUR</option>
            </select>
        </div>
    </div>

    <div id="tableContainer">
        <!-- Table with 4 columns will be displayed here -->
    </div>

    <button id="addRowBtn" style="display: none;">Add Row</button>
    <div id="totalSumOutput" class="total-sum-output" style="display: none;"></div>




    <script src="../js/main.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", async function () {
            try {
                const searchInput = document.getElementById("searchInput");
                const searchResults = document.getElementById("searchResults");
                const tableContainer = document.getElementById("tableContainer");
                const currencySelect = document.getElementById("currencySelect");
                const addRowBtn = document.getElementById("addRowBtn");

                // Variable to track whether to initially show two results in the scroll-down
                let initiallyShowTwoResults = true;

                // Function to display search results as a dropdown
                function displaySearchResults(results) {
                    searchResults.innerHTML = "";

                    // Limit the number of results to show
                    const maxResultsToShow = initiallyShowTwoResults ? 2 : 5;
                    const resultsToShow = results.slice(0, maxResultsToShow);

                    if (resultsToShow && resultsToShow.length > 0) {
                        resultsToShow.forEach(account => {
                            const listItem = document.createElement("li");
                            listItem.textContent = account.accountstring;
                            listItem.addEventListener("click", function () {
                                selectResult(account);
                            });
                            searchResults.appendChild(listItem);
                        });
                    } else {
                        searchResults.innerHTML = "<li>No results found</li>";
                    }
                }

                // Function to handle search input and fetch results
                async function handleSearchInput() {
                    // Only fetch results if there is at least one character in the search input
                    if (searchInput.value.length > 0) {
                        const encodedSearchInput = encodeURIComponent(searchInput.value);
                        const apiUrl = `${baseUrl}invoce.php?customername=${encodedSearchInput}`;

                        const response = await fetch(apiUrl);

                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }

                        const data = await response.text();
                        const jsonStartIndex = data.indexOf('[');
                        const jsonString = data.slice(jsonStartIndex);
                        const jsonData = JSON.parse(jsonString);

                        displaySearchResults(jsonData);
                    } else {
                        // Clear search results if the search input is empty
                        searchResults.innerHTML = "";
                    }
                }

                // Event listener for search input changes
                searchInput.addEventListener("input", handleSearchInput);

                // Function to select a result from the search and display the table
                function selectResult(account) {
                    // Set the selected result as the search input value
                    searchInput.value = account.accountstring;
                    // Clear search results
                    searchResults.innerHTML = "";
                    // Display the table
                    displayTable(account);
                }

                function displayTable(account) {
                    // Create a table with columns: Item, Price, Quantity, and Total Price
                    const table = document.createElement("table");
                    table.classList.add("responsive-table");

                    // Set an id for the table
                    table.id = "invoiceTable";

                    // Create header row
                    const headerRow = table.insertRow(0);
                    const headers = ["Item", "Price", "Quantity", "Total Price"];

                    headers.forEach(headerText => {
                        const th = document.createElement("th");
                        th.textContent = headerText;
                        headerRow.appendChild(th);
                    });

                    // Create data row
                    const dataRow = table.insertRow(1);

                    // Populate data cells with input fields for editing
                    for (let i = 0; i < headers.length; i++) {
                        const cell = dataRow.insertCell(i);
                        const input = document.createElement("input");

                        input.type = "text";
                        input.value = account[headers[i].toLowerCase()] || "";

                        // Add unique id or name attributes to each input field
                        input.id = headers[i].toLowerCase();
                        input.name = headers[i].toLowerCase();

                        // Add an event listener for the "Quantity" field
                        if (headers[i] === "Quantity") {
                            input.addEventListener("input", function () {
                                updateTotalPrice(table);
                            });
                        }

                        // Disable the "Total Price" field
                        if (headers[i] === "Total Price") {
                            input.disabled = true;
                            input.name = "totalPrice";
                        }

                        cell.appendChild(input);
                    }

                    // Clear previous tables
                    tableContainer.innerHTML = "";
                    tableContainer.appendChild(table);

                    // Calculate initial total price
                    updateTotalPrice(table);

                    // Show the "Add Row" button and Total Sum
                    addRowBtn.style.display = "block";
                    totalSumOutput.style.display = "block";
                }

                // Function to update the "Total Price" based on "Price" and "Quantity"
                function updateTotalPrice(table) {
                    // Get all rows in the table
                    const rows = table.querySelectorAll('tbody tr');

                    rows.forEach(row => {
                        const priceInput = row.querySelector('input[name="price"]');
                        const quantityInput = row.querySelector('input[name="quantity"]');
                        const totalPriceInput = row.querySelector('input[name="totalPrice"]');

                        if (priceInput && quantityInput && totalPriceInput) {
                            // Parse values as floats
                            const price = parseFloat(priceInput.value) || 0;
                            const quantity = parseFloat(quantityInput.value) || 0;

                            // Calculate total price for each row
                            const totalPrice = price * quantity;

                            // Update the "Total Price" input field for each row
                            totalPriceInput.value = totalPrice.toFixed(2);
                        }
                    });

                    // Calculate and display the total sum
                    calculateTotalSum();
                }

                // Event listener for the "Add Row" button
                addRowBtn.addEventListener("click", function () {
                    addRow();
                });

                // Function to add a new row to the table
                function addRow() {
                    const table = document.getElementById("invoiceTable");

                    if (table) {
                        const newRow = table.insertRow(table.rows.length);
                        const headers = ["Item", "Price", "Quantity", "Total Price"];

                        for (let i = 0; i < headers.length; i++) {
                            const cell = newRow.insertCell(i);
                            const input = document.createElement("input");

                            input.type = "text";
                            input.value = "";
                            input.id = headers[i].toLowerCase();
                            input.name = headers[i].toLowerCase();

                            // Add an event listener for the "Quantity" and "Price" fields
                            if (headers[i] === "Quantity" || headers[i] === "Price") {
                                input.addEventListener("input", function () {
                                    updateTotalPrice(table);
                                });
                            }

                            // Disable the "Total Price" field
                            if (headers[i] === "Total Price") {
                                input.disabled = true;
                                input.name = "totalPrice";
                            }

                            cell.appendChild(input);
                        }

                        // Calculate total price for the new row
                        updateTotalPrice(table);
                    }
                }

                // Function to calculate and display the total sum of "Total Price"
                function calculateTotalSum() {
                    const table = document.getElementById("invoiceTable");
                    let totalSum = 0;

                    if (table) {
                        // Get all rows in the table
                        const rows = table.querySelectorAll('tbody tr');

                        rows.forEach(row => {
                            const totalPriceInput = row.querySelector('input[name="totalPrice"]');

                            if (totalPriceInput) {
                                // Parse value as a float
                                const totalPrice = parseFloat(totalPriceInput.value) || 0;

                                // Accumulate total sum
                                totalSum += totalPrice;
                            }
                        });
                    }

                    // Update the text content of the total sum output div element
                    const totalSumOutput = document.getElementById("totalSumOutput");
                    if (totalSumOutput) {
                        totalSumOutput.textContent = `Total Sum of "Total Price": ${totalSum.toFixed(2)}`;
                    }

                    console.log(totalSum);
                }

            } catch (error) {
                console.error("An error occurred:", error);
            }
        });

    </script>
</body>

</html>